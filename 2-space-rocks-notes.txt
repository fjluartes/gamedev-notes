SPACE ROCKS
- Game 2 of Godot 4 book
- Asteroids clone

NOTES
Project Setup
Project Settings > Input Map
- rotate_left, rotate_right, thrust, shoot

Rigid Body physics
- StaticBody2D
- RigidBody2D
- CharacterBody2D
Project Settings > General > Physics > 2D

For space ship and rocks
- Use RigidBody2D
- Area2D can also be used by using Space Override

PLAYER'S SHIP
Body and Physics setup
Player (RigidBody2D)
- Sprite2D
- CollisionShape2D
Sprite2D
- Scale - (0.5, 0.5)
- Rotation - 90
CollisionShape2D
- CircleShape2D
Other
- Project Settings > Rendering > Textures
	- Default Texture Filter - Nearest

State machines
- Init, Alive, Invulnerable, Dead
- match new_state (switch)
- $CollisionShape2D.set_deferred("disabled", true)
	- For Invulnerable only

Player Controls
@export var engine_power = 500
@export var spin_power = 8000
thrust = Vector2.ZERO
rotation_dir = 0
if Input.is_action_pressed("thrust"):
	thrust = transform.x * engine_power
rotation_dir = Input.get_axis("rotate_left", "rotate_right")

func _physics_process(delta):
	constant_force = thrust
	constant_torque = rotation_dir * spin_power

Screen Wrap
- If player goes off on one side of screen, appears on other side
- Can't just use if position.x > screensize.x: position.x = 0
	- use _integrate_forces on RigidBody2D

func _integrate_forces(physics_state):
	var xform = physics_state.transform
	xform.origin.x = wrapf(xform.origin.x, 0, screensize.x)
	xform.origin.y = wrapf(xform.origin.y, 0, screensize.y)
	physics_state.transform = xform

physics_state -> PhysicsDirectBodyState2D
wrapf(<value>, <min-value>, <max-value>)

SHOOTING
Bullet scene
Bullet (Area2D)
- Sprite2D
- CollisionShape2D
- VisibleOnScreenNotifier2D

@export var speed = 1000
var velocity = Vector2.ZERO

func start(_transform):
	transform = _transform
	velocity = transform.x * speed

func _process(delta):
	position += velocity * delta

(signal)
_on_visible_on_screen_notifier_2d_screen_exited():
	queue_free()

(signal)
_on_bullet_body_entered(body):
	if body.is_in_group("rocks"):
		body.explode()
		queue_free()

Main scene
Main (Node2D)
- Background (Sprite2D)
- Player (PackedScene)
- RockPath (Path2D)

ADDING THE ROCKS
Rocks scene
Rock (RigidBody2D)
- Sprite2D
- CollisionShape2D

Linear/Damp = 0
Angular/Damp = 0
Damp Mode (for both) = Replace
PhysicsMaterial > Bounce = 1

func start(_position, _velocity, _size):
	position = _position
	size = _size
	mass = 1.5 * size
	$Sprite2D.scale = Vector2.ONE * scale_factor * size
	radius = int($Sprite2D.texture.get_size().x / 2 * $Sprite2D.scale.x)
	var shape = CircleShape2D.new() # generate new circleshape for rock collision
	shape.radius = radius
	$CollisionShape2D.shape = shape
	linear_velocity = _velocity
	angular_velocity = randf_range(-PI, PI)

func _integrate_forces(physics_state):
	var xform = physics_state.transform
	xform.origin.x = wrapf(xform.origin.x, 0 - radius, screensize.x + radius)
	xform.origin.y = wrapf(xform.origin.y, 0 - radius, screensize.y + radius)
	physics_state.transform = xform

On Main Scene
RockPath (Path2D)
- RockSpawn (PathFollow2D)
Add Point - top left corner then clockwise
Close Curve

func _ready() -> void:
	screensize = get_viewport().get_visible_rect().size
	for i in 3:
		spawn_rock(3)

func spawn_rock(size, pos=null, vel=null):
	if pos == null:
		var rock_spawn = $RockPath / RockSpawn
		rock_spawn.progress = randi()
		pos = rock_spawn.position
	if vel == null:
		vel = Vector2.RIGHT.rotated(randf_range(0, TAU)) * randf_range(50, 125)
	var r = rock_scene.instantiate()
	r.screensize = screensize
	r.start(pos, vel, size)
	call_deferred("add_child", r)

Exploding rocks
Explosion (Sprite2D)
- AnimationPlayer
Sprite2D
- Vframes = 8, Hframes = 8 -> split sprite sheet to 64 images (0 - 63)
AnimationPlayer
- New > "explosion"
- Animation Length = 0.64, Snap = 0.01
- Zoom in Animation track (right side is animation length)
key, keyframe
- Click key icon on Frame 0 and Frame 63 (start and end frames)
- Set Frame = 0 in Time = 0.0 and Frame = 63 on Time = 0.63 (start and end frames)
- Update Mode > Continuous
Add explosion scene to Rock scene
Rock scene
- Add to start()
	- $Explosion.scale = Vector2.ONE * 0.75 * size
	
Question
- When to use?
	- @export var explosion : PackedScene vs 
	- $Explosion (add Explosion as child scene in Rock scene)

Spawn smaller rocks
- Rock emits exploded signal, Main listens for exploded and generate smaller rocks
- r.exploded.connect(self._on_rock_exploded)